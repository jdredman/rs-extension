<!DOCTYPE html>
<html>
<head>
    <title>Debug HTML Generation</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .debug-section {
            border: 1px solid #ccc;
            margin: 20px;
            padding: 15px;
        }
        .debug-output {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Debug HTML Generation Test</h1>
    
    <div class="debug-section">
        <h2>Step 1: Test createLinkCard function</h2>
        <div id="link-card-test" class="debug-output"></div>
        <h3>Generated HTML:</h3>
        <pre id="link-card-html"></pre>
    </div>
    
    <div class="debug-section">
        <h2>Step 2: Test formatAssistantMessage function</h2>
        <div id="format-test" class="debug-output"></div>
        <h3>Input text:</h3>
        <pre id="format-input"></pre>
        <h3>Output HTML:</h3>
        <pre id="format-output"></pre>
    </div>

    <script>
        // Copy functions from popup.js
        function createLinkCard(result) {
            const title = result.title || 'Untitled';
            const url = result.url || '#';
            const description = result.description || 'No description available';
            const displayLink = result.displayLink || new URL(url).hostname;
            const favicon = result.favicon || `https://www.google.com/s2/favicons?domain=${displayLink}`;
            
            return `<div class="link-preview"><div class="link-preview-header"><img src="${favicon}" alt="Site icon" class="link-favicon" onerror="this.style.display='none'"><span class="link-domain">${displayLink}</span></div><div class="link-preview-body"><h4 class="link-title"><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a></h4><p class="link-description">${description}</p></div></div>`;
        }

        function formatMarkdownText(text) {
            // Escape HTML to prevent XSS
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Apply basic markdown formatting
            formatted = formatted
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // Inline code
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Handle lists
            formatted = formatted.replace(/^- (.*$)/gim, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            formatted = formatted.replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            // Wrap in paragraphs if not already wrapped and not empty
            if (formatted.trim() && !formatted.includes('<p>') && !formatted.includes('<ul>') && !formatted.includes('<ol>')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            return formatted;
        }

        function formatAssistantMessage(text) {
            console.log('formatAssistantMessage input:', text);
            
            // Check if the text already contains HTML (from search results)
            if (text.includes('<div class="link-preview">') || text.includes('<div class="youtube-embed">')) {
                console.log('Contains HTML, processing with placeholder method');
                
                // Find all HTML blocks first
                const htmlBlocks = [];
                const placeholders = [];
                
                // Replace HTML blocks with placeholders
                let tempText = text;
                const htmlRegex = /<div class="(?:link-preview|youtube-embed)"[\s\S]*?<\/div>/g;
                let match;
                let index = 0;
                
                while ((match = htmlRegex.exec(text)) !== null) {
                    const placeholder = `__HTML_BLOCK_${index}__`;
                    htmlBlocks.push(match[0]);
                    placeholders.push(placeholder);
                    tempText = tempText.replace(match[0], placeholder);
                    index++;
                }
                
                console.log('HTML blocks found:', htmlBlocks.length);
                console.log('Text with placeholders:', tempText);
                
                // Format the text without HTML as markdown
                let formatted = formatMarkdownText(tempText);
                console.log('After markdown formatting:', formatted);
                
                // Restore HTML blocks
                for (let i = 0; i < placeholders.length; i++) {
                    formatted = formatted.replace(placeholders[i], htmlBlocks[i]);
                }
                
                console.log('Final result:', formatted);
                return formatted;
            }
            
            // No HTML present, format as regular markdown
            console.log('No HTML, processing as pure markdown');
            return formatMarkdownText(text);
        }

        // Test data
        const testResult = {
            title: "EveryDollar - Free Budgeting App",
            url: "https://www.ramseysolutions.com/ramseyplus/everydollar",
            description: "Create a zero-based budget with EveryDollar. Give every dollar a job before you spend it.",
            displayLink: "ramseysolutions.com",
            favicon: "https://www.google.com/s2/favicons?domain=ramseysolutions.com",
            type: "tool"
        };

        // Test 1: createLinkCard
        const linkHTML = createLinkCard(testResult);
        document.getElementById('link-card-test').innerHTML = linkHTML;
        document.getElementById('link-card-html').textContent = linkHTML;

        // Test 2: formatAssistantMessage with mixed content
        const aiResponse = "Here are some budgeting resources that can help you:";
        const mixedContent = aiResponse + '\n\n' + linkHTML;
        
        document.getElementById('format-input').textContent = mixedContent;
        
        const formattedHTML = formatAssistantMessage(mixedContent);
        document.getElementById('format-test').innerHTML = formattedHTML;
        document.getElementById('format-output').textContent = formattedHTML;

        console.log('Link card HTML:', linkHTML);
        console.log('Mixed content input:', mixedContent);
        console.log('Formatted output:', formattedHTML);
    </script>
</body>
</html>
