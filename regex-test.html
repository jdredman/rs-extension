<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regex Test for formatAssistantMessage</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .test { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Regex Test for formatAssistantMessage</h1>
    
    <div class="test">
        <h2>Testing the regex extraction logic</h2>
        <div id="results"></div>
    </div>

    <script>
        // This is the problematic regex logic from your extension
        function testRegexLogic(text) {
            console.log('=== TESTING REGEX LOGIC ===');
            console.log('Input text:', text);
            
            const htmlBlocks = [];
            const placeholders = [];
            
            // Replace HTML blocks with placeholders
            let tempText = text;
            const htmlRegex = /<div class="(?:link-preview|youtube-embed)"[\s\S]*?<\/div>/g;
            let match;
            let index = 0;
            
            console.log('Starting while loop...');
            while ((match = htmlRegex.exec(text)) !== null) {
                console.log(`Match ${index}:`, match[0]);
                const placeholder = `__HTML_BLOCK_${index}__`;
                htmlBlocks.push(match[0]);
                placeholders.push(placeholder);
                tempText = tempText.replace(match[0], placeholder);
                index++;
                
                // Safety check to prevent infinite loop
                if (index > 10) {
                    console.error('Breaking loop - too many iterations!');
                    break;
                }
            }
            
            console.log('HTML blocks found:', htmlBlocks.length);
            console.log('Placeholders:', placeholders);
            console.log('Temp text after replacement:', tempText);
            
            return {
                htmlBlocks,
                placeholders,
                tempText
            };
        }
        
        // Test with sample HTML that should be found
        const sampleHTML = `Here's what I found:

<div class="link-preview"><div class="link-preview-header"><img src="https://www.google.com/s2/favicons?domain=ramseysolutions.com" alt="Site icon" class="link-favicon" onerror="this.style.display='none'"><span class="link-domain">ramseysolutions.com</span></div><div class="link-preview-body"><h4 class="link-title"><a href="https://www.ramseysolutions.com/debt/how-to-pay-off-debt-with-the-debt-snowball-plan" target="_blank" rel="noopener noreferrer">How to Pay Off Debt Fast With the Debt Snowball Method</a></h4><p class="link-description">The debt snowball method helps you pay off debt fast by focusing on your smallest debt first while making minimum payments on the rest.</p></div></div>

This should help you get started!`;

        const result = testRegexLogic(sampleHTML);
        
        document.getElementById('results').innerHTML = `
            <h3>Results:</h3>
            <p><strong>HTML blocks found:</strong> ${result.htmlBlocks.length}</p>
            <p><strong>Placeholders:</strong> ${result.placeholders.join(', ')}</p>
            <h4>Original text:</h4>
            <pre>${sampleHTML}</pre>
            <h4>Text after placeholder replacement:</h4>
            <pre>${result.tempText}</pre>
            <h4>First HTML block found:</h4>
            <pre>${result.htmlBlocks[0] || 'None'}</pre>
        `;
    </script>
</body>
</html>
