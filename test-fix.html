<!DOCTYPE html>
<html>
<head>
    <title>Test Search Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { border-color: #4CAF50; background-color: #f9fff9; }
        .error { border-color: #f44336; background-color: #fff9f9; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Search Functionality Test</h1>
    
    <div id="test-results"></div>
    
    <script>
        // Import functions from popup.js for testing
        const CONFIG = {
            TRUSTED_DOMAINS: [
                'ramseysolutions.com',
                'labs.ramseysolutions.com',
                'youtube.com',
                'youtu.be'
            ],
            MAX_SEARCH_RESULTS: 5,
            MAX_YOUTUBE_RESULTS: 3
        };

        // Sample data for testing
        const SAMPLE_SEARCH_RESULTS = [
            {
                title: "Emergency Fund Basics: How to Save $1,000 Fast",
                url: "https://www.ramseysolutions.com/dave-ramsey-7-baby-steps/baby-step-1",
                description: "Learn how to build your starter emergency fund of $1,000 quickly. This is the first step in Dave Ramsey's proven plan for financial peace.",
                displayLink: "ramseysolutions.com",
                favicon: "https://www.google.com/s2/favicons?domain=ramseysolutions.com",
                type: "article"
            },
            {
                title: "EveryDollar Budgeting App - Free Budget Tool",
                url: "https://www.ramseysolutions.com/ramseyplus/everydollar",
                description: "Create a zero-based budget with EveryDollar. Give every dollar a job before you spend it. Free budgeting app that follows Dave Ramsey's proven money plan.",
                displayLink: "ramseysolutions.com",
                favicon: "https://www.google.com/s2/favicons?domain=ramseysolutions.com",
                type: "tool"
            },
            {
                title: "How to Build an Emergency Fund - Dave Ramsey",
                url: "https://www.youtube.com/watch?v=test123",
                description: "Dave Ramsey explains the importance of an emergency fund and how to build one fast.",
                displayLink: "youtube.com",
                favicon: "https://www.google.com/s2/favicons?domain=youtube.com",
                type: "video",
                videoId: "test123",
                thumbnail: "https://img.youtube.com/vi/test123/mqdefault.jpg"
            }
        ];

        function extractYouTubeId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length === 11) ? match[7] : null;
        }

        function enhanceSearchResult(result) {
            const enhanced = { ...result };
            
            // Add YouTube video ID if it's a YouTube URL
            if (result.url && (result.url.includes('youtube.com') || result.url.includes('youtu.be'))) {
                const videoId = extractYouTubeId(result.url);
                if (videoId) {
                    enhanced.videoId = videoId;
                    enhanced.type = 'video';
                    enhanced.thumbnail = enhanced.thumbnail || `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                }
            }
            
            // Add favicon if not present
            if (!enhanced.favicon && enhanced.url) {
                try {
                    const domain = new URL(enhanced.url).hostname;
                    enhanced.favicon = `https://www.google.com/s2/favicons?domain=${domain}`;
                } catch (e) {
                    enhanced.favicon = 'https://www.google.com/s2/favicons?domain=ramseysolutions.com';
                }
            }
            
            return enhanced;
        }

        function createLinkPreview(result) {
            if (result.type === 'video' && result.videoId) {
                return createYouTubeEmbed(result);
            } else {
                return createLinkCard(result);
            }
        }

        function createYouTubeEmbed(result) {
            return `
                <div class="youtube-embed" data-video-id="${result.videoId}">
                    <div class="youtube-thumbnail" style="background-image: url('${result.thumbnail}')">
                        <div class="youtube-play-button">
                            <svg width="68" height="48" viewBox="0 0 68 48">
                                <path d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.63-3.26,5.42-6.19C68.94,34.95,69,24,69,24S68.94,13.05,66.52,7.74z" fill="#f00"></path>
                                <path d="M 45,24 27,14 27,34" fill="#fff"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="youtube-info">
                        <h4 class="youtube-title">${result.title}</h4>
                        <p class="youtube-description">${result.description}</p>
                        <a href="${result.url}" target="_blank" rel="noopener noreferrer" class="youtube-link">
                            Watch on YouTube
                        </a>
                    </div>
                </div>
            `;
        }

        function createLinkCard(result) {
            const typeIcon = result.type === 'tool' ? 'üõ†Ô∏è' : 'üìÑ';
            return `
                <div class="link-preview" data-url="${result.url}">
                    <div class="link-preview-content">
                        <div class="link-preview-text">
                            <h4 class="link-preview-title">
                                ${typeIcon} ${result.title}
                            </h4>
                            <p class="link-preview-description">${result.description}</p>
                            <div class="link-preview-meta">
                                <img src="${result.favicon}" alt="favicon" class="link-preview-favicon">
                                <span class="link-preview-domain">${result.displayLink || new URL(result.url).hostname}</span>
                            </div>
                        </div>
                    </div>
                    <a href="${result.url}" target="_blank" rel="noopener noreferrer" class="link-preview-link">
                        Visit Page
                    </a>
                </div>
            `;
        }

        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            let allPassed = true;

            // Test 1: Sample search results enhancement
            try {
                const enhanced = SAMPLE_SEARCH_RESULTS.map(result => enhanceSearchResult(result));
                const youtubeResult = enhanced.find(r => r.type === 'video');
                
                if (youtubeResult && youtubeResult.videoId === 'test123') {
                    addTestResult('‚úÖ Test 1: Search result enhancement', 'success', 'YouTube video ID extracted correctly');
                } else {
                    throw new Error('YouTube video ID not extracted');
                }
            } catch (e) {
                allPassed = false;
                addTestResult('‚ùå Test 1: Search result enhancement', 'error', e.message);
            }

            // Test 2: HTML preview generation
            try {
                const enhanced = SAMPLE_SEARCH_RESULTS.map(result => enhanceSearchResult(result));
                const htmlPreviews = enhanced.map(result => createLinkPreview(result));
                
                const hasYouTubeEmbed = htmlPreviews.some(html => html.includes('youtube-embed'));
                const hasLinkCard = htmlPreviews.some(html => html.includes('link-preview'));
                
                if (hasYouTubeEmbed && hasLinkCard) {
                    addTestResult('‚úÖ Test 2: HTML preview generation', 'success', 'Both YouTube embeds and link cards generated');
                } else {
                    throw new Error('Missing YouTube embed or link card');
                }
            } catch (e) {
                allPassed = false;
                addTestResult('‚ùå Test 2: HTML preview generation', 'error', e.message);
            }

            // Test 3: HTML structure validation
            try {
                const enhanced = enhanceSearchResult(SAMPLE_SEARCH_RESULTS[2]); // YouTube result
                const html = createYouTubeEmbed(enhanced);
                
                if (html.includes('data-video-id="test123"') && html.includes('youtube-embed')) {
                    addTestResult('‚úÖ Test 3: YouTube embed structure', 'success', 'YouTube embed has correct structure and video ID');
                } else {
                    throw new Error('YouTube embed structure invalid');
                }
            } catch (e) {
                allPassed = false;
                addTestResult('‚ùå Test 3: YouTube embed structure', 'error', e.message);
            }

            // Summary
            const summary = allPassed ? 
                'üéâ All tests passed! The search functionality should now work correctly.' :
                '‚ö†Ô∏è Some tests failed. Please check the implementation.';
            
            addTestResult(summary, allPassed ? 'success' : 'error');
        }

        function addTestResult(title, className, details = '') {
            const resultsDiv = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.className = `test-result ${className}`;
            testDiv.innerHTML = `
                <h3>${title}</h3>
                ${details ? `<p>${details}</p>` : ''}
            `;
            resultsDiv.appendChild(testDiv);
        }

        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>
