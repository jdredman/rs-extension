<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Complete Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .extension-sim {
            width: 450px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        .chat-messages {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 20px;
            background: #fafafa;
        }
        .message {
            margin-bottom: 20px;
            padding: 12px;
            border-radius: 12px;
        }
        .user-message {
            background: #ebf4fa;
            color: #333;
            border: 1px solid #d8f1fc;
            margin-left: 30px;
        }
        .assistant-message {
            background: transparent;
            color: #333;
            padding: 12px 0;
            margin-right: 30px;
            max-width: 100%;
        }
        button {
            padding: 12px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* Copy exact extension styles */
        .link-preview {
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            background-color: #fff;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .link-preview:hover {
            border-color: #dee2e6;
        }
        
        .link-preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .link-favicon {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        .link-domain {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .link-preview-body {
            margin-top: 8px;
        }
        
        .link-title {
            margin: 0 0 8px 0;
            font-size: 15px;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .link-title a {
            color: #007bff;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .link-title a:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        
        .link-description {
            margin: 0;
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        
        /* Assistant message formatting */
        .assistant-message p {
            margin: 0 0 12px 0;
        }
        
        .assistant-message strong {
            font-weight: 600;
            color: #333;
        }
        
        .assistant-message em {
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Final Complete Extension Test</h1>
    
    <div class="extension-sim">
        <h3>üè¶ Ramsey Assistant</h3>
        <div class="chat-messages" id="chatMessages"></div>
        <button onclick="testDebtQuery()">Test: "Do you have videos about debt?"</button>
        <button onclick="testBudgetQuery()">Test: "Help me with budgeting"</button>
        <button onclick="clearChat()">Clear Chat</button>
        
        <div class="success" id="status" style="display: none;"></div>
    </div>

    <script>
        // EXACT COPIES OF ALL EXTENSION FUNCTIONS

        function createLinkCard(result) {
            const title = result.title || 'Untitled';
            const url = result.url || '#';
            const description = result.description || 'No description available';
            const displayLink = result.displayLink || new URL(url).hostname;
            const favicon = result.favicon || `https://www.google.com/s2/favicons?domain=${displayLink}`;
            
            return `<div class="link-preview"><div class="link-preview-header"><img src="${favicon}" alt="Site icon" class="link-favicon" onerror="this.style.display='none'"><span class="link-domain">${displayLink}</span></div><div class="link-preview-body"><h4 class="link-title"><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a></h4><p class="link-description">${description}</p></div></div>`;
        }

        function createYouTubeEmbed(result) {
            const title = result.title || 'Untitled Video';
            const description = result.description || 'No description available';
            const thumbnail = result.thumbnail || `https://img.youtube.com/vi/${result.videoId}/mqdefault.jpg`;
            const url = result.url || `https://www.youtube.com/watch?v=${result.videoId}`;
            
            return `<div class="youtube-embed" data-video-id="${result.videoId}"><div class="youtube-thumbnail" style="background-image: url('${thumbnail}')"><div class="youtube-play-button"><svg width="68" height="48" viewBox="0 0 68 48"><path d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z" fill="#f00"></path><path d="M 45,24 27,14 27,34" fill="#fff"></path></svg></div></div><div class="youtube-info"><h4 class="youtube-title">${title}</h4><p class="youtube-description">${description}</p><a href="${url}" target="_blank" rel="noopener noreferrer" class="youtube-link">Watch on YouTube</a></div></div>`;
        }

        function createLinkPreview(result) {
            if (result.type === 'video' && result.videoId) {
                return createYouTubeEmbed(result);
            } else {
                return createLinkCard(result);
            }
        }

        function formatMarkdownText(text) {
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            formatted = formatted
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            formatted = formatted.replace(/^- (.*$)/gim, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            formatted = formatted.replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            if (formatted.trim() && !formatted.includes('<p>') && !formatted.includes('<ul>') && !formatted.includes('<ol>')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            return formatted;
        }

        // UPDATED IMPROVED VERSION
        function formatAssistantMessage(text) {
            if (text.includes('<div class="link-preview">') || text.includes('<div class="youtube-embed">')) {
                const htmlRegex = /<div class="(?:link-preview|youtube-embed)"[\s\S]*?<\/div>/g;
                const matches = Array.from(text.matchAll(htmlRegex));
                
                if (matches.length === 0) {
                    return formatMarkdownText(text);
                }
                
                const htmlBlocks = [];
                const placeholders = [];
                let tempText = text;
                
                for (let i = matches.length - 1; i >= 0; i--) {
                    const match = matches[i];
                    const placeholder = `__HTML_BLOCK_${i}__`;
                    htmlBlocks.unshift(match[0]);
                    placeholders.unshift(placeholder);
                    
                    tempText = tempText.substring(0, match.index) + placeholder + tempText.substring(match.index + match[0].length);
                }
                
                let formatted = formatMarkdownText(tempText);
                
                for (let i = 0; i < placeholders.length; i++) {
                    formatted = formatted.replace(placeholders[i], htmlBlocks[i]);
                }
                
                return formatted;
            }
            
            return formatMarkdownText(text);
        }

        function addMessageToDOM(text, type) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message', `${type}-message`);
            
            if (type === 'assistant') {
                const formattedText = formatAssistantMessage(text);
                messageEl.innerHTML = formattedText;
            } else {
                messageEl.textContent = text;
            }
            
            document.getElementById('chatMessages').appendChild(messageEl);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function getSampleSearchResults(query, searchType) {
            const results = [];
            
            if (query.includes('debt')) {
                results.push({
                    title: "How to Pay Off Debt Fast With the Debt Snowball Method",
                    url: "https://www.ramseysolutions.com/debt/how-to-pay-off-debt-with-the-debt-snowball-plan",
                    description: "The debt snowball method helps you pay off debt fast by focusing on your smallest debt first while making minimum payments on the rest.",
                    displayLink: "ramseysolutions.com",
                    favicon: "https://www.google.com/s2/favicons?domain=ramseysolutions.com",
                    type: "article"
                });
                
                if (query.includes('video')) {
                    results.push({
                        title: "Dave Ramsey: Debt Snowball vs Debt Avalanche",
                        url: "https://www.youtube.com/watch?v=example123",
                        description: "Dave explains why the debt snowball method works better than debt avalanche for most people.",
                        displayLink: "youtube.com",
                        favicon: "https://www.google.com/s2/favicons?domain=youtube.com",
                        type: "video",
                        videoId: "example123",
                        thumbnail: "https://img.youtube.com/vi/example123/mqdefault.jpg"
                    });
                }
            }
            
            if (query.includes('budget')) {
                results.push({
                    title: "How to Make a Budget in 5 Simple Steps",
                    url: "https://www.ramseysolutions.com/budgeting/how-to-make-a-budget",
                    description: "Learn how to create a zero-based budget that gives every dollar a purpose. Start taking control of your money today with these simple steps.",
                    displayLink: "ramseysolutions.com",
                    favicon: "https://www.google.com/s2/favicons?domain=ramseysolutions.com",
                    type: "article"
                });
                
                results.push({
                    title: "EveryDollar - Free Budgeting App",
                    url: "https://www.ramseysolutions.com/ramseyplus/everydollar",
                    description: "Create a zero-based budget with EveryDollar. Give every dollar a job before you spend it. Free budgeting app that follows Dave Ramsey's proven money plan.",
                    displayLink: "ramseysolutions.com",
                    favicon: "https://www.google.com/s2/favicons?domain=ramseysolutions.com",
                    type: "tool"
                });
            }
            
            return results;
        }

        function simulateSearch(userQuery, searchQuery) {
            addMessageToDOM(userQuery, "user");
            
            setTimeout(() => {
                const searchResults = getSampleSearchResults(searchQuery);
                // USING IMPROVED JOIN WITH DOUBLE NEWLINES
                const formattedResults = searchResults.map(result => createLinkPreview(result)).join('\n\n');
                
                const aiResponse = "I found some great resources that can help you:";
                const finalResponse = aiResponse + '\n\n' + formattedResults;
                
                console.log('=== FINAL TEST DEBUG ===');
                console.log('Search results count:', searchResults.length);
                console.log('Formatted results length:', formattedResults.length);
                console.log('Final response preview:', finalResponse.substring(0, 200) + '...');
                
                addMessageToDOM(finalResponse, 'assistant');
                
                showStatus(`‚úÖ Successfully rendered ${searchResults.length} search result(s) with proper HTML formatting!`);
            }, 800);
        }

        function testDebtQuery() {
            simulateSearch("Do you have any videos about debt?", "debt video");
        }

        function testBudgetQuery() {
            simulateSearch("Help me with budgeting", "budget");
        }

        function clearChat() {
            document.getElementById('chatMessages').innerHTML = '';
            hideStatus();
        }

        function showStatus(message) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
    </script>
</body>
</html>
