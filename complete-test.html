<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete formatAssistantMessage Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .test { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            border: 2px solid #007bff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }
        
        /* Link preview styles */
        .link-preview {
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            background-color: #fff;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .link-preview:hover {
            border-color: #dee2e6;
        }
        
        .link-preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .link-favicon {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        .link-domain {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .link-preview-body {
            margin-top: 8px;
        }
        
        .link-title {
            margin: 0 0 8px 0;
            font-size: 15px;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .link-title a {
            color: #007bff;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .link-title a:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        
        .link-description {
            margin: 0;
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <h1>Complete formatAssistantMessage Test</h1>
    
    <div class="test">
        <h2>Simulating the exact function calling scenario</h2>
        <div id="step1">
            <h3>Step 1: AI Response</h3>
            <pre id="aiResponse"></pre>
        </div>
        
        <div id="step2">
            <h3>Step 2: Search Results HTML</h3>
            <pre id="searchHTML"></pre>
        </div>
        
        <div id="step3">
            <h3>Step 3: Combined finalResponse</h3>
            <pre id="finalResponse"></pre>
        </div>
        
        <div id="step4">
            <h3>Step 4: After formatAssistantMessage()</h3>
            <pre id="formattedResult"></pre>
        </div>
        
        <div id="step5">
            <h3>Step 5: Rendered Result</h3>
            <div class="result" id="renderedResult"></div>
        </div>
    </div>

    <script>
        // Exact copy of your functions
        function formatMarkdownText(text) {
            // Escape HTML to prevent XSS
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Apply basic markdown formatting
            formatted = formatted
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // Inline code
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Handle lists
            formatted = formatted.replace(/^- (.*$)/gim, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            formatted = formatted.replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            // Wrap in paragraphs if not already wrapped and not empty
            if (formatted.trim() && !formatted.includes('<p>') && !formatted.includes('<ul>') && !formatted.includes('<ol>')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            return formatted;
        }

        function formatAssistantMessage(text) {
            console.log('=== formatAssistantMessage DEBUG ===');
            console.log('Input text:', text);
            console.log('Contains link-preview?', text.includes('<div class="link-preview">'));
            console.log('Contains youtube-embed?', text.includes('<div class="youtube-embed">'));
            
            // Check if the text already contains HTML (from search results)
            if (text.includes('<div class="link-preview">') || text.includes('<div class="youtube-embed">')) {
                console.log('HTML detected, processing...');
                
                // Find all HTML blocks first
                const htmlBlocks = [];
                const placeholders = [];
                
                // Replace HTML blocks with placeholders
                let tempText = text;
                const htmlRegex = /<div class="(?:link-preview|youtube-embed)"[\s\S]*?<\/div>/g;
                let match;
                let index = 0;
                
                // Use matchAll instead of while loop to avoid potential issues
                const matches = Array.from(text.matchAll(htmlRegex));
                console.log('Found matches:', matches.length);
                
                for (const match of matches) {
                    const placeholder = `__HTML_BLOCK_${index}__`;
                    htmlBlocks.push(match[0]);
                    placeholders.push(placeholder);
                    tempText = tempText.replace(match[0], placeholder);
                    console.log(`Replaced block ${index}:`, match[0].substring(0, 100) + '...');
                    index++;
                }
                
                console.log('tempText after replacement:', tempText);
                
                // Format the text without HTML as markdown
                let formatted = formatMarkdownText(tempText);
                console.log('After formatMarkdownText:', formatted);
                
                // Restore HTML blocks
                for (let i = 0; i < placeholders.length; i++) {
                    formatted = formatted.replace(placeholders[i], htmlBlocks[i]);
                    console.log(`Restored placeholder ${i}:`, placeholders[i]);
                }
                
                console.log('Final formatted result:', formatted);
                return formatted;
            }
            
            // No HTML present, format as regular markdown
            console.log('No HTML detected, using regular markdown');
            return formatMarkdownText(text);
        }

        function createLinkCard(result) {
            const title = result.title || 'Untitled';
            const url = result.url || '#';
            const description = result.description || 'No description available';
            const displayLink = result.displayLink || new URL(url).hostname;
            const favicon = result.favicon || `https://www.google.com/s2/favicons?domain=${displayLink}`;
            
            return `<div class="link-preview"><div class="link-preview-header"><img src="${favicon}" alt="Site icon" class="link-favicon" onerror="this.style.display='none'"><span class="link-domain">${displayLink}</span></div><div class="link-preview-body"><h4 class="link-title"><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a></h4><p class="link-description">${description}</p></div></div>`;
        }

        // Simulate the exact scenario from your extension
        const aiResponse = "I found some great resources about debt payoff that can help you get started:";
        
        const searchResult = {
            title: "How to Pay Off Debt Fast With the Debt Snowball Method",
            url: "https://www.ramseysolutions.com/debt/how-to-pay-off-debt-with-the-debt-snowball-plan",
            description: "The debt snowball method helps you pay off debt fast by focusing on your smallest debt first while making minimum payments on the rest.",
            displayLink: "ramseysolutions.com",
            favicon: "https://www.google.com/s2/favicons?domain=ramseysolutions.com",
            type: "article"
        };
        
        const searchHTML = createLinkCard(searchResult);
        const finalResponse = aiResponse + '\n\n' + searchHTML;
        const formattedResult = formatAssistantMessage(finalResponse);
        
        // Display all steps
        document.getElementById('aiResponse').textContent = aiResponse;
        document.getElementById('searchHTML').textContent = searchHTML;
        document.getElementById('finalResponse').textContent = finalResponse;
        document.getElementById('formattedResult').textContent = formattedResult;
        document.getElementById('renderedResult').innerHTML = formattedResult;
        
        // Console output for debugging
        console.log('=== FINAL COMPARISON ===');
        console.log('Original search HTML length:', searchHTML.length);
        console.log('Final response length:', finalResponse.length);
        console.log('Formatted result length:', formattedResult.length);
        console.log('Contains link-preview in final?', formattedResult.includes('link-preview'));
    </script>
</body>
</html>
