<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Conversation Context Memory</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        
        .conversation-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        
        .user-message {
            background-color: #e3f2fd;
            text-align: right;
        }
        
        .assistant-message {
            background-color: #f3e5f5;
            text-align: left;
        }
        
        .messages-array {
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-button {
            padding: 10px 20px;
            background-color: #0084c1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        .test-button:hover {
            background-color: #006ea0;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>Conversation Context Memory Test</h1>
    
    <div class="test-container">
        <h2>Simulated Conversation</h2>
        <div id="conversation-display">
            <div class="conversation-message user-message">
                <strong>User:</strong> Hi, I'm looking to get out of debt. What's the first step?
            </div>
            <div class="conversation-message assistant-message">
                <strong>Assistant:</strong> The first step in Dave Ramsey's plan is Baby Step 1: Save $1,000 for your starter emergency fund. This gives you a small cushion while you tackle your debt.
            </div>
            <div class="conversation-message user-message">
                <strong>User:</strong> What's the next step after that?
            </div>
        </div>
        
        <button id="test-context" class="test-button">Test Context Memory</button>
        <button id="reset-conversation" class="test-button">Reset Conversation</button>
    </div>
    
    <div class="test-container">
        <h3>Generated Messages Array for OpenAI</h3>
        <div id="messages-output" class="messages-array">
            Click "Test Context Memory" to see the messages array that would be sent to OpenAI API
        </div>
    </div>
    
    <div id="result-output"></div>
    
    <script>
        // Simulate the conversation state from popup.js
        let currentConversation = {
            id: null,
            messages: [],
            createdAt: null
        };
        
        // Simulate adding messages to conversation (from popup.js)
        function addMessage(text, type) {
            currentConversation.messages.push({ text, type });
        }
        
        // Initialize the test conversation
        function initializeTestConversation() {
            currentConversation = {
                id: Date.now().toString(),
                messages: [],
                createdAt: new Date().toISOString()
            };
            
            // Add the conversation history shown in the UI
            addMessage("Hi, I'm looking to get out of debt. What's the first step?", "user");
            addMessage("The first step in Dave Ramsey's plan is Baby Step 1: Save $1,000 for your starter emergency fund. This gives you a small cushion while you tackle your debt.", "assistant");
            addMessage("What's the next step after that?", "user");
        }
        
        // Simulate the context building logic from the updated popup.js
        function buildContextualMessages(newUserInput) {
            const systemMessage = `I am an official representative of Ramsey Solutions. I speak and advise as part of our team, giving guidance that is 100% aligned with our financial principles, teachings, and tone. I follow our 7 Baby Steps, encourage debt freedom, promote zero-based budgeting, and always speak with the confidence and clarity of a Ramsey Personality.`;
            
            // Build messages array starting with system message
            const messages = [
                {
                    role: 'system',
                    content: systemMessage
                }
            ];
            
            // Add conversation history to maintain context (excluding the current user message)
            const historyMessages = currentConversation.messages.slice(0, -1); // Exclude the last message (current user input)
            historyMessages.forEach(msg => {
                if (msg.text && msg.type && typeof msg.text === 'string') {
                    if (msg.type === 'user') {
                        messages.push({
                            role: 'user',
                            content: msg.text
                        });
                    } else if (msg.type === 'assistant') {
                        // Clean HTML from assistant messages
                        const cleanContent = msg.text.replace(/<div class="(?:link-preview|youtube-embed)"[\s\S]*?<\/div>\s*<\/div>/g, '[Resource links provided]');
                        messages.push({
                            role: 'assistant',
                            content: cleanContent
                        });
                    }
                }
            });
            
            // Add current user message
            messages.push({
                role: 'user',
                content: newUserInput
            });
            
            return messages;
        }
        
        // Test the context memory functionality
        function testContextMemory() {
            const newUserInput = "What's the next step after that?";
            
            // This simulates what happens when the user asks a follow-up question
            const messages = buildContextualMessages(newUserInput);
            
            // Display the messages array
            const messagesOutput = document.getElementById('messages-output');
            messagesOutput.textContent = JSON.stringify(messages, null, 2);
            
            // Analyze the results
            const resultOutput = document.getElementById('result-output');
            let result = '<div class="result">';
            
            // Check if conversation history is included
            const hasHistory = messages.some(msg => 
                msg.role === 'user' && msg.content.includes("I'm looking to get out of debt")
            );
            
            const hasAssistantHistory = messages.some(msg => 
                msg.role === 'assistant' && msg.content.includes("Baby Step 1")
            );
            
            const hasCurrentQuestion = messages.some(msg => 
                msg.role === 'user' && msg.content.includes("What's the next step after that")
            );
            
            if (hasHistory && hasAssistantHistory && hasCurrentQuestion) {
                result += '<div class="success">';
                result += '<h3>✅ SUCCESS: Conversation Context is Working!</h3>';
                result += '<p><strong>✓ Previous user question found:</strong> The AI will remember the user asked about getting out of debt</p>';
                result += '<p><strong>✓ Previous assistant response found:</strong> The AI will remember it mentioned Baby Step 1</p>';
                result += '<p><strong>✓ Current question included:</strong> The follow-up question "What\'s the next step after that?" is properly contextualized</p>';
                result += '<p><strong>Result:</strong> The AI should understand that the user is asking about Baby Step 2 (debt snowball) based on the conversation context.</p>';
            } else {
                result += '<div class="error">';
                result += '<h3>❌ ISSUE: Conversation Context Problem Detected</h3>';
                result += `<p>Previous user question found: ${hasHistory ? '✓' : '❌'}</p>`;
                result += `<p>Previous assistant response found: ${hasAssistantHistory ? '✓' : '❌'}</p>`;
                result += `<p>Current question included: ${hasCurrentQuestion ? '✓' : '❌'}</p>`;
            }
            
            result += '</div></div>';
            resultOutput.innerHTML = result;
        }
        
        // Reset the conversation for testing
        function resetConversation() {
            initializeTestConversation();
            document.getElementById('messages-output').textContent = 'Click "Test Context Memory" to see the messages array that would be sent to OpenAI API';
            document.getElementById('result-output').innerHTML = '';
        }
        
        // Event listeners
        document.getElementById('test-context').addEventListener('click', testContextMemory);
        document.getElementById('reset-conversation').addEventListener('click', resetConversation);
        
        // Initialize on page load
        initializeTestConversation();
    </script>
</body>
</html>
