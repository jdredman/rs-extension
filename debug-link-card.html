<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Link Card Issue</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .test-container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result { 
            border: 1px solid #ddd; 
            padding: 15px; 
            background-color: #f9f9f9; 
            margin-top: 10px;
            border-radius: 4px;
        }
        
        /* Copy the link preview styles from your extension */
        .link-preview {
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            background-color: #fff;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .link-preview:hover {
            border-color: #dee2e6;
        }
        
        .link-preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .link-favicon {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }
        
        .link-domain {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .link-preview-body {
            margin-top: 8px;
        }
        
        .link-title {
            margin: 0 0 8px 0;
            font-size: 15px;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .link-title a {
            color: #007bff;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .link-title a:hover {
            color: #0056b3;
            text-decoration: underline;
        }
        
        .link-description {
            margin: 0;
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <h1>Debug Link Card Issue</h1>
    
    <div class="test-container">
        <h2>Test 1: Direct createLinkCard function</h2>
        <p>Testing the createLinkCard function directly:</p>
        <div class="result" id="test1"></div>
    </div>
    
    <div class="test-container">
        <h2>Test 2: formatAssistantMessage with HTML</h2>
        <p>Testing formatAssistantMessage function with mixed content:</p>
        <div class="result" id="test2"></div>
    </div>
    
    <div class="test-container">
        <h2>Test 3: Simulated function calling response</h2>
        <p>Testing the exact scenario from function calling:</p>
        <div class="result" id="test3"></div>
    </div>

    <script>
        // Copy your functions here for testing
        function createLinkCard(result) {
            // Ensure all required properties exist with fallbacks
            const title = result.title || 'Untitled';
            const url = result.url || '#';
            const description = result.description || 'No description available';
            const displayLink = result.displayLink || new URL(url).hostname;
            const favicon = result.favicon || `https://www.google.com/s2/favicons?domain=${displayLink}`;
            
            // Build HTML string without extra whitespace that might cause issues
            return `<div class="link-preview"><div class="link-preview-header"><img src="${favicon}" alt="Site icon" class="link-favicon" onerror="this.style.display='none'"><span class="link-domain">${displayLink}</span></div><div class="link-preview-body"><h4 class="link-title"><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a></h4><p class="link-description">${description}</p></div></div>`;
        }

        function formatMarkdownText(text) {
            // Escape HTML to prevent XSS
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Apply basic markdown formatting
            formatted = formatted
                // Bold text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // Inline code
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // Handle lists
            formatted = formatted.replace(/^- (.*$)/gim, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            formatted = formatted.replace(/^(\d+)\. (.*$)/gim, '<li>$2</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            // Wrap in paragraphs if not already wrapped and not empty
            if (formatted.trim() && !formatted.includes('<p>') && !formatted.includes('<ul>') && !formatted.includes('<ol>')) {
                formatted = '<p>' + formatted + '</p>';
            }
            
            return formatted;
        }

        function formatAssistantMessage(text) {
            // Check if the text already contains HTML (from search results)
            if (text.includes('<div class="link-preview">') || text.includes('<div class="youtube-embed">')) {
                // Find all HTML blocks first
                const htmlBlocks = [];
                const placeholders = [];
                
                // Replace HTML blocks with placeholders
                let tempText = text;
                const htmlRegex = /<div class="(?:link-preview|youtube-embed)"[\s\S]*?<\/div>/g;
                let match;
                let index = 0;
                
                while ((match = htmlRegex.exec(text)) !== null) {
                    const placeholder = `__HTML_BLOCK_${index}__`;
                    htmlBlocks.push(match[0]);
                    placeholders.push(placeholder);
                    tempText = tempText.replace(match[0], placeholder);
                    index++;
                }
                
                // Format the text without HTML as markdown
                let formatted = formatMarkdownText(tempText);
                
                // Restore HTML blocks
                for (let i = 0; i < placeholders.length; i++) {
                    formatted = formatted.replace(placeholders[i], htmlBlocks[i]);
                }
                
                return formatted;
            }
            
            // No HTML present, format as regular markdown
            return formatMarkdownText(text);
        }

        // Test 1: Direct createLinkCard function
        const testResult = {
            title: "How to Pay Off Debt Fast With the Debt Snowball Method",
            url: "https://www.ramseysolutions.com/debt/how-to-pay-off-debt-with-the-debt-snowball-plan",
            description: "The debt snowball method helps you pay off debt fast by focusing on your smallest debt first while making minimum payments on the rest.",
            displayLink: "ramseysolutions.com",
            favicon: "https://www.google.com/s2/favicons?domain=ramseysolutions.com",
            type: "article"
        };

        const linkCardHTML = createLinkCard(testResult);
        document.getElementById('test1').innerHTML = linkCardHTML;
        
        // Test 2: formatAssistantMessage with HTML
        const mixedContent = `Here's what I found about debt payoff:

${linkCardHTML}

This is a great resource to get started with your debt-free journey!`;

        const formattedMixed = formatAssistantMessage(mixedContent);
        document.getElementById('test2').innerHTML = formattedMixed;
        
        // Test 3: Simulated function calling response (this is what your extension should be doing)
        const aiResponse = "I found some great resources about debt payoff that can help you get started:";
        const searchResultsHTML = linkCardHTML;
        const finalResponse = aiResponse + '\n\n' + searchResultsHTML;
        
        const finalFormatted = formatAssistantMessage(finalResponse);
        document.getElementById('test3').innerHTML = finalFormatted;
        
        // Log all the intermediate steps to console for debugging
        console.log('=== DEBUG OUTPUT ===');
        console.log('1. Original linkCardHTML:', linkCardHTML);
        console.log('2. Mixed content:', mixedContent);
        console.log('3. Formatted mixed:', formattedMixed);
        console.log('4. Final response:', finalResponse);
        console.log('5. Final formatted:', finalFormatted);
    </script>
</body>
</html>
